FROM php:8.4.8-fpm-alpine3.22

# Variables de entorno
ENV PHP_VERSION=8.4.8
ENV PHALCON_VERSION=5.9.3
ARG TARGETARCH
ARG TARGETPLATFORM

# Mostrar informaciÃ³n de la plataforma de build
RUN echo "ğŸ—ï¸  Building for: ${TARGETPLATFORM:-unknown}" && \
    echo "ğŸ“¦ Architecture: ${TARGETARCH:-unknown}" && \
    uname -m

# Verificar versiÃ³n PHP
RUN php -v && \
    if [ $(php -r "echo PHP_MAJOR_VERSION.'.'.PHP_MINOR_VERSION;") != "8.4" ]; then \
        echo "âŒ Error: PHP version is not 8.4" && exit 1; \
    else \
        echo "âœ… PHP 8.4 verificado correctamente"; \
    fi

# Definir dependencias de desarrollo
ENV PHPIZE_DEPS="autoconf dpkg-dev dpkg file g++ gcc libc-dev make pkgconf re2c"

# Instalar dependencias del sistema con optimizaciones por arquitectura
RUN apk update && apk upgrade && \
    apk add --no-cache \
        $PHPIZE_DEPS \
        git \
        libxml2-dev \
        libzip-dev \
        curl-dev \
        libwebp-dev \
        freetype-dev \
        libjpeg-turbo-dev \
        libpng-dev \
        oniguruma-dev \
        gettext-dev \
        openssl-dev \
        zlib-dev \
        imagemagick \
        imagemagick-dev \
        libmemcached-dev \
        cyrus-sasl-dev \
    && echo "âœ… Dependencias del sistema instaladas"

# Instalar extensiones PHP bÃ¡sicas con optimizaciones por arquitectura
RUN set -ex && \
    if [ "${TARGETARCH}" = "arm64" ] || [ "${TARGETARCH}" = "aarch64" ]; then \
        PARALLEL_JOBS=$(($(nproc) > 2 ? 2 : $(nproc))); \
    else \
        PARALLEL_JOBS=$(nproc); \
    fi && \
    echo "ğŸš€ Using ${PARALLEL_JOBS} parallel processes for ${TARGETARCH}" && \
    docker-php-ext-install -j${PARALLEL_JOBS} \
        pdo \
        pdo_mysql \
        bcmath \
        curl \
        soap \
        fileinfo \
        gettext \
        mbstring \
        zip && \
    docker-php-ext-configure gd \
        --enable-gd \
        --with-webp \
        --with-jpeg \
        --with-freetype && \
    docker-php-ext-install -j${PARALLEL_JOBS} gd && \
    echo "âœ… Extensiones PHP bÃ¡sicas y GD instaladas"

# Instalar extensiones PECL con manejo de errores mejorado
RUN set -ex && \
    echo "ğŸ“¦ Instalando extensiÃ³n PSR..." && \
    pecl install psr && \
    docker-php-ext-enable psr && \
    php -m | grep psr && \
    echo "âœ… PSR instalado correctamente"

RUN set -ex && \
    echo "ğŸ“¦ Instalando ImageMagick..." && \
    pecl install imagick && \
    docker-php-ext-enable imagick && \
    php -m | grep imagick && \
    echo "âœ… ImageMagick instalado correctamente"

RUN set -ex && \
    echo "ğŸ“¦ Instalando Memcached..." && \
    pecl install memcached && \
    docker-php-ext-enable memcached && \
    php -m | grep memcached && \
    echo "âœ… Memcached instalado correctamente"

# Instalar Phalcon con manejo especÃ­fico por arquitectura
RUN set -ex && \
    echo "ğŸ“¦ Instalando Phalcon ${PHALCON_VERSION} para ${TARGETARCH}..." && \
    case ${TARGETARCH} in \
        amd64) \
            echo "ğŸ—ï¸  InstalaciÃ³n optimizada para AMD64" && \
            pecl install phalcon-${PHALCON_VERSION} \
            ;; \
        arm64|aarch64) \
            echo "ğŸ—ï¸  InstalaciÃ³n para ARM64 (puede tardar mÃ¡s)" && \
            pecl install phalcon-${PHALCON_VERSION} \
            ;; \
        *) \
            echo "ğŸ—ï¸  InstalaciÃ³n genÃ©rica para ${TARGETARCH}" && \
            pecl install phalcon-${PHALCON_VERSION} \
            ;; \
    esac && \
    docker-php-ext-enable phalcon && \
    php -m | grep phalcon && \
    echo "âœ… Phalcon ${PHALCON_VERSION} instalado correctamente para ${TARGETARCH}"

# VerificaciÃ³n final de todas las extensiones
RUN set -ex && \
    echo "ğŸ” Verificando todas las extensiones..." && \
    php -m | grep -i pdo && echo "âœ… PDO" && \
    php -m | grep -i curl && echo "âœ… cURL" && \
    php -m | grep -i gd && echo "âœ… GD" && \
    php -m | grep -i imagick && echo "âœ… ImageMagick" && \
    php -m | grep -i memcached && echo "âœ… Memcached" && \
    php -m | grep -i phalcon && echo "âœ… Phalcon" && \
    php -m | grep -i psr && echo "âœ… PSR" && \
    echo "ğŸ‰ Todas las extensiones instaladas correctamente en ${TARGETPLATFORM}"

# Limpiar dependencias de build y cachÃ©
RUN set -ex && \
    echo "ğŸ§¹ Limpiando cachÃ© y dependencias..." && \
    apk del $PHPIZE_DEPS && \
    rm -rf /var/cache/apk/* /tmp/* /var/tmp/* /usr/share/man ~/.pearrc && \
    echo "âœ… Limpieza completada"

# Configurar PHP-FPM
RUN mkdir -p /var/log/php-fpm && \
    chown www-data:www-data /var/log/php-fpm && \
    echo "âœ… PHP-FPM configurado"

# InformaciÃ³n final del build
RUN set -ex && \
    echo "ğŸ“‹ InformaciÃ³n del contenedor:" && \
    echo "ğŸ˜ PHP: $(php -v | head -n 1)" && \
    echo "ğŸ—ï¸  Plataforma: ${TARGETPLATFORM:-unknown}" && \
    echo "ğŸ“¦ Arquitectura: ${TARGETARCH:-unknown}" && \
    echo "ğŸ› ï¸  Sistema: $(uname -m)" && \
    echo "ğŸ¯ Phalcon: $(php -m | grep -i phalcon || echo 'No detectado')"

EXPOSE 9000

# Healthcheck
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD php-fpm-healthcheck || exit 1

CMD ["php-fpm"]